"use strict";var __assign=function(){return(__assign=Object.assign||function(t){for(var n,e=1,r=arguments.length;e<r;e++)for(var i in n=arguments[e])Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i]);return t}).apply(this,arguments)};function __awaiter(o,a,s,u){return new(s=s||Promise)(function(t,n){function e(t){try{i(u.next(t))}catch(t){n(t)}}function r(t){try{i(u.throw(t))}catch(t){n(t)}}function i(n){n.done?t(n.value):new s(function(t){t(n.value)}).then(e,r)}i((u=u.apply(o,a||[])).next())})}function __generator(e,r){var i,o,a,t,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return t={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function n(n){return function(t){return function(n){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,o&&(a=2&n[0]?o.return:n[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,n[1])).done)return a;switch(o=0,a&&(n=[2&n[0],a.value]),n[0]){case 0:case 1:a=n;break;case 4:return s.label++,{value:n[1],done:!1};case 5:s.label++,o=n[1],n=[0];continue;case 7:n=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===n[0]||2===n[0])){s=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){s.label=n[1];break}if(6===n[0]&&s.label<a[1]){s.label=a[1],a=n;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(n);break}a[2]&&s.ops.pop(),s.trys.pop();continue}n=r.call(e,s)}catch(t){n=[6,t],o=0}finally{i=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,t])}}}var postData=function(t){var n=t.url,e=t.data,r=void 0===e?"":e,i=t.config,o=void 0===i?{}:i;if(!n)throw new Error("Url is missing in fetch!");var a="string"==typeof r?r:JSON.stringify(r);return fetch(n,__assign({},{body:a,cache:"no-cache",headers:{"content-type":"application/json"},method:"POST",mode:"cors"},o)).then(function(t){return t.json()}).catch(function(t){throw new Error("Fetch error: "+t)})},getOSName=function(){var t;return-1!==window.navigator.userAgent.indexOf("Android")?t="Android":-1!==window.navigator.userAgent.indexOf("iPhone")?t="iPhone":-1!==window.navigator.userAgent.indexOf("SymbianOS")?t="SymbianOS":-1!==window.navigator.userAgent.indexOf("Windows Phone")?t="Windows Phone":-1!==window.navigator.userAgent.indexOf("iPad")?t="iPad":-1!==window.navigator.userAgent.indexOf("iPod")?t="iPod":-1!==window.navigator.userAgent.indexOf("Windows")?t="Windows":-1!==window.navigator.userAgent.indexOf("Mac")?t="Mac":-1!==window.navigator.userAgent.indexOf("X11")?t="UNIX":-1!==window.navigator.userAgent.indexOf("Linux")&&(t="Linux"),t};function uuidv4(){var e=(new Date).getTime();return"undefined"!=typeof performance&&"function"==typeof performance.now&&(e+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:3&n|8).toString(16)})}var JSSDK=function(){function n(t){var n=t.limit,e=void 0===n?1:n,r=t.url,i=t.productid,o=t.xwho;if(!r||!i)throw new Error("JSSDK constructor error: url or productid is missing!");this.limit=e,this.url=r,this.productid=i,this.xwho=o||this.getXWho(),this.eventList=[],this.xcontext={$app_version:"",$os:getOSName(),$lib_version:"V1.0",$debug:1}}return n.init=function(t){return new n(t)},n.prototype.getContext=function(){return{productid:this.productid,url:this.url,xwho:this.xwho}},n.prototype.track=function(t){console.log("track: active!");var n=this.mergeEvent(t);return this.eventList.push(n),this.isReachLimit()?this.publish():this.eventList.length},n.prototype.publish=function(r){return void 0===r&&(r=this.url),__awaiter(this,void 0,void 0,function(){var n,e;return __generator(this,function(t){switch(t.label){case 0:return n=__assign({},this.eventList),[4,postData({url:r,data:n})];case 1:return e=t.sent(),console.log("response: ",e),this.eventList=[],[2,e]}})})},n.prototype.isReachLimit=function(){return this.eventList.length>=this.limit},n.prototype.getXWho=function(){var t=localStorage.getItem("xwho");return t||(t=uuidv4(),localStorage.setItem("xwho",t)),t},n.prototype.mergeEvent=function(t){var n={productid:this.productid,xwhen:(new Date).getTime(),xwho:this.xwho};return t.xcontext=t.xcontext?__assign({},this.xcontext,t.xcontext):t.xcontext,__assign({},n,t)},n}();module.exports=JSSDK;
